# /etc/nginx/sites-available/innoaggie.conf
server {
  listen 80;
  listen 443 ssl http2;
  server_name innoaggie.com www.innoaggie.com;

  # (your ssl_certificate / ssl_certificate_key here)

  # --- Frontend (Next.js) at /
  location / {
    proxy_pass         http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # --- Strapi Admin SPA at /admin
  # Important: the admin is a single-page app; fall back to /admin/index.html
  location ^~ /admin/ {
    # (optional) lock it down (choose one or both)
    # allow  your.office.ip/32; deny all;
    # auth_basic "Restricted"; auth_basic_user_file /etc/nginx/.htpasswd;

    proxy_pass         http://127.0.0.1:1337/admin/;
    proxy_http_version 1.1;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;

    # support any admin deep-link like /admin/settings/users
    # Strapi serves the compiled admin files itself; we just pass through
    # If you instead serve built assets from Nginx, see note below.
  }

  # Redirect /admin (no trailing slash) -> /admin/
  location = /admin {
    return 301 /admin/;
  }

  # --- Strapi API (optional but recommended for clarity)
  location /api/ {
    proxy_pass         http://127.0.0.1:1337/api/;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  # --- Strapi static uploads
  location /uploads/ {
    proxy_pass http://127.0.0.1:1337/uploads/;
    # Cache static files at the edge
    proxy_buffering on;
    expires 7d;
    add_header Cache-Control "public, max-age=604800, immutable";
  }

  # --- Stripe webhook (your small Express app) at /webhook
  location = /webhook {
    proxy_pass         http://127.0.0.1:8084;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
  }

  client_max_body_size 25m;
  # Optional: harden
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}